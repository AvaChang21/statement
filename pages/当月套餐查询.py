import pandas as pd
import re
import streamlit as st
import io


def read_sheets(df):
    data = {}
    for name in df.sheet_names[:6]:
        df_pre = df.parse(sheet_name=name)
        data[name] = df_pre

    return data


def repack_data(data):
    clean_data = {}

    for k, v in data.items():
        ndf = pd.DataFrame(
            columns=['é›¶å”®ç”¨æˆ·åç§°', 'åˆåŒå¼€å§‹æ—¥æœŸ', 'åˆåŒç»“æŸæ—¥æœŸ', 'é•¿åæ¯”ä¾‹', 'é•¿åä½äºéƒ¨åˆ†ç”²æ–¹', 'é•¿åä½äºéƒ¨åˆ†ä¹™æ–¹',
                     'æœˆç«æ¯”ä¾‹', 'æœˆç«ä½äºéƒ¨åˆ†ç”²æ–¹', 'æœˆç«ä½äºéƒ¨åˆ†ä¹™æ–¹', 'ä»£è´­æ¯”ä¾‹', 'ä»£è´­ç›ˆåˆ©ç”²æ–¹å æ¯”',
                     'ä»£è´­ç›ˆåˆ©ä¹™æ–¹å æ¯”',
                     'å¹´åº¦é•¿åäº¤æ˜“å‡ä»·', 'æœˆåº¦ç«ä»·å‡ºæ¸…ä»·', 'ä»£è´­ä»·æ ¼',
                     'å›ºå®šæœåŠ¡è´¹', 'å›ºå®šä»·æ ¼', 'å½’å±', 'åŸºå‡†ä»·', 'é¢„ä¼°ç”µé‡', 'å¤‡æ³¨'])

        pattern1 = r'\d+\.\d+'
        if k == 'æ ‡å‡†å¥—é¤':
            ndf['é›¶å”®ç”¨æˆ·åç§°'] = v['é›¶å”®ç”¨æˆ·åç§°']
            ndf['åˆåŒå¼€å§‹æ—¥æœŸ'] = v['åˆåŒå¼€å§‹æ—¥æœŸ']
            ndf['åˆåŒç»“æŸæ—¥æœŸ'] = v['åˆåŒç»“æŸæ—¥æœŸ']
            ndf['é•¿åæ¯”ä¾‹'] = v['é•¿åæ¯”ä¾‹']
            ndf['é•¿åä½äºéƒ¨åˆ†ç”²æ–¹'] = v['é•¿åç›ˆåˆ©ç”²æ–¹å æ¯”']
            ndf['é•¿åä½äºéƒ¨åˆ†ä¹™æ–¹'] = v['é•¿åç›ˆåˆ©ä¹™æ–¹å æ¯”']

            ndf['æœˆç«æ¯”ä¾‹'] = v['æœˆç«æ¯”ä¾‹']
            ndf['æœˆç«ä½äºéƒ¨åˆ†ç”²æ–¹'] = v['æœˆåº¦ç›ˆåˆ©ç”²æ–¹å æ¯”']
            ndf['æœˆç«ä½äºéƒ¨åˆ†ä¹™æ–¹'] = v['æœˆåº¦ç›ˆåˆ©ä¹™æ–¹å æ¯”']

            ndf['åŸºå‡†ä»·'] = v['åˆ†æˆåŸºå‡†ä»·'].apply(lambda x: re.findall(pattern1, x)[0])

            clean_data[k] = ndf

        if k == 'å›ºå®šæ‰‹ç»­è´¹':
            ndf['é›¶å”®ç”¨æˆ·åç§°'] = v['é›¶å”®ç”¨æˆ·åç§°']
            ndf['åˆåŒå¼€å§‹æ—¥æœŸ'] = v['åˆåŒå¼€å§‹æ—¥æœŸ']
            ndf['åˆåŒç»“æŸæ—¥æœŸ'] = v['åˆåŒç»“æŸæ—¥æœŸ']
            ndf['é•¿åæ¯”ä¾‹'] = v['é•¿åæ¯”ä¾‹']
            ndf['æœˆç«æ¯”ä¾‹'] = v['æœˆç«æ¯”ä¾‹']
            ndf['å¹´åº¦é•¿åäº¤æ˜“å‡ä»·'] = v['å¹´åº¦é•¿åäº¤æ˜“å‡ä»·']
            ndf['æœˆåº¦ç«ä»·å‡ºæ¸…ä»·'] = v['æœˆåº¦ç«ä»·å‡ºæ¸…ä»·']

            clean_data[k] = ndf

        if k == 'åˆ†æˆåŠ ä¿åº•':
            ndf['é›¶å”®ç”¨æˆ·åç§°'] = v['é›¶å”®ç”¨æˆ·åç§°']
            ndf['åˆåŒå¼€å§‹æ—¥æœŸ'] = v['åˆåŒå¼€å§‹æ—¥æœŸ']
            ndf['åˆåŒç»“æŸæ—¥æœŸ'] = v['åˆåŒç»“æŸæ—¥æœŸ']
            ndf['å›ºå®šä»·æ ¼'] = v['é›¶å”®å›ºå®šæˆäº¤ä»·/ç›¸å¯¹è®©åˆ©ä»·']

            clean_data[k] = ndf

        if k == 'å›ºå®šä»·æ ¼ç±»':
            ndf['é›¶å”®ç”¨æˆ·åç§°'] = v['é›¶å”®ç”¨æˆ·åç§°']
            ndf['åˆåŒå¼€å§‹æ—¥æœŸ'] = v['åˆåŒå¼€å§‹æ—¥æœŸ']
            ndf['åˆåŒç»“æŸæ—¥æœŸ'] = v['åˆåŒç»“æŸæ—¥æœŸ']
            ndf['å›ºå®šä»·æ ¼'] = v['å›ºå®šä»·æ ¼']

            clean_data[k] = ndf

        if k == 'ä»·æ ¼æµ®åŠ¨ç±»':
            ndf['é›¶å”®ç”¨æˆ·åç§°'] = v['é›¶å”®ç”¨æˆ·åç§°']
            ndf['åˆåŒå¼€å§‹æ—¥æœŸ'] = v['åˆåŒå¼€å§‹æ—¥æœŸ']
            ndf['åˆåŒç»“æŸæ—¥æœŸ'] = v['åˆåŒç»“æŸæ—¥æœŸ']

            ndf['é•¿åæ¯”ä¾‹'] = v['ä»·æ ¼æµ®åŠ¨ç±»é•¿åå æ¯”']
            ndf['æœˆç«æ¯”ä¾‹'] = v['ä»·æ ¼æµ®åŠ¨ç±»æœˆç«å æ¯”']
            ndf['ä»£è´­æ¯”ä¾‹'] = v['ä»·æ ¼æµ®åŠ¨ç±»ä»£è´­å æ¯”']

            ndf['å¹´åº¦é•¿åäº¤æ˜“å‡ä»·'] = v['ä»·æ ¼æµ®åŠ¨ç±»é•¿åä»·æ ¼']
            ndf['æœˆåº¦ç«ä»·å‡ºæ¸…ä»·'] = v['ä»·æ ¼æµ®åŠ¨ç±»æœˆç«ä»·æ ¼']
            ndf['ä»£è´­ä»·æ ¼'] = v['ä»·æ ¼æµ®åŠ¨ç±»ä»£è´­ä»·æ ¼']

            clean_data[k] = ndf

        if k == 'æ¯”ä¾‹åˆ†æˆç±»':
            ndf['é›¶å”®ç”¨æˆ·åç§°'] = v['é›¶å”®ç”¨æˆ·åç§°']
            ndf['åˆåŒå¼€å§‹æ—¥æœŸ'] = v['åˆåŒå¼€å§‹æ—¥æœŸ']
            ndf['åˆåŒç»“æŸæ—¥æœŸ'] = v['åˆåŒç»“æŸæ—¥æœŸ']

            ndf['åŸºå‡†ä»·'] = v['åˆ†æˆå‚è€ƒä»·'].apply(lambda x: re.findall(pattern1, x)[0])

            ndf['é•¿åæ¯”ä¾‹'] = v['åˆ†æˆé•¿åå æ¯”']
            ndf['é•¿åä½äºéƒ¨åˆ†ç”²æ–¹'] = v['åˆ†æˆé•¿åç›ˆåˆ©ç”²æ–¹å æ¯”']
            ndf['é•¿åä½äºéƒ¨åˆ†ä¹™æ–¹'] = v['åˆ†æˆé•¿åç›ˆåˆ©ä¹™æ–¹å æ¯”']

            ndf['æœˆç«æ¯”ä¾‹'] = v['åˆ†æˆæœˆç«å æ¯”']
            ndf['æœˆç«ä½äºéƒ¨åˆ†ç”²æ–¹'] = v['åˆ†æˆæœˆç«ç›ˆåˆ©ç”²æ–¹å æ¯”']
            ndf['æœˆç«ä½äºéƒ¨åˆ†ä¹™æ–¹'] = v['åˆ†æˆæœˆç«ç›ˆåˆ©ä¹™æ–¹å æ¯”']

            ndf['ä»£è´­æ¯”ä¾‹'] = v['åˆ†æˆä»£è´­å æ¯”']
            ndf['ä»£è´­ç›ˆåˆ©ç”²æ–¹å æ¯”'] = v['åˆ†æˆä»£è´­ç›ˆåˆ©ç”²æ–¹å æ¯”']
            ndf['ä»£è´­ç›ˆåˆ©ä¹™æ–¹å æ¯”'] = v['åˆ†æˆä»£è´­ç›ˆåˆ©ä¹™æ–¹å æ¯”']

            clean_data[k] = ndf

    return clean_data


def find_date(df, year_month):
    df['åˆåŒå¼€å§‹æ—¥æœŸ'] = pd.to_datetime(df['åˆåŒå¼€å§‹æ—¥æœŸ']).dt.date
    df['åˆåŒç»“æŸæ—¥æœŸ'] = pd.to_datetime(df['åˆåŒç»“æŸæ—¥æœŸ']).dt.date

    start_date = pd.to_datetime(year_month + '-01').date()  # '2025-03-01'
    end_date = pd.to_datetime(year_month + '-01') + pd.offsets.MonthEnd(0)  # '2025-03-31'
    end_date = end_date.date()

    filtered_df = df[(df['åˆåŒå¼€å§‹æ—¥æœŸ'] <= start_date) & (df['åˆåŒç»“æŸæ—¥æœŸ'] >= end_date)]

    return filtered_df


uploaded_file = st.file_uploader("ä¸Šä¼  Excel æ–‡ä»¶", type=["xlsx", "xls"])

if uploaded_file:
    xls = pd.ExcelFile(uploaded_file)
    sheet_names = xls.sheet_names

    data = {}
    for sheet in sheet_names[:6]:
        data[sheet] = pd.read_excel(xls, sheet_name=sheet)

    clean_data = repack_data(data)

    a = pd.concat(clean_data)
    year_month = st.text_input('è¯·è¾“å…¥å½“å‰å¹´æœˆ, e.g. 2025-03', '')
    if year_month:
        df = find_date(a, year_month)

        # å°† DataFrame å†™å…¥ Excel
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
            df.to_excel(writer, index=False, sheet_name="Sheet1")
        output.seek(0)  # é‡è¦ï¼šé‡ç½®æŒ‡é’ˆä½ç½®

        # æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
        st.download_button(
            label="ğŸ“¥ ä¸‹è½½æ•´ç†åçš„å¥—é¤æ–‡ä»¶",
            data=output,
            file_name=f"{year_month}å¥—é¤.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
